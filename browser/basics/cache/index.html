<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>缓存策略 | 会飞的鱼🐟</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="学习笔记">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.5fc96bdf.js" as="script"><link rel="preload" href="/assets/js/2.56cd01f5.js" as="script"><link rel="preload" href="/assets/js/53.fddcc9c3.js" as="script"><link rel="prefetch" href="/assets/js/10.3ea21215.js"><link rel="prefetch" href="/assets/js/11.f2af6ae8.js"><link rel="prefetch" href="/assets/js/12.644b56f9.js"><link rel="prefetch" href="/assets/js/13.321b16b6.js"><link rel="prefetch" href="/assets/js/14.c75e2d6b.js"><link rel="prefetch" href="/assets/js/15.5b62c749.js"><link rel="prefetch" href="/assets/js/16.1365c67d.js"><link rel="prefetch" href="/assets/js/17.b89f8d5a.js"><link rel="prefetch" href="/assets/js/18.c2b2881c.js"><link rel="prefetch" href="/assets/js/19.793ae888.js"><link rel="prefetch" href="/assets/js/20.ceb40dc7.js"><link rel="prefetch" href="/assets/js/21.3872ab50.js"><link rel="prefetch" href="/assets/js/22.cdd80890.js"><link rel="prefetch" href="/assets/js/23.b89f5df5.js"><link rel="prefetch" href="/assets/js/24.00cc879e.js"><link rel="prefetch" href="/assets/js/25.e7d9e711.js"><link rel="prefetch" href="/assets/js/26.38dfa295.js"><link rel="prefetch" href="/assets/js/27.42e5a51b.js"><link rel="prefetch" href="/assets/js/28.f29c5a5a.js"><link rel="prefetch" href="/assets/js/29.9c1152d0.js"><link rel="prefetch" href="/assets/js/3.5ad5b76e.js"><link rel="prefetch" href="/assets/js/30.fb98a7fd.js"><link rel="prefetch" href="/assets/js/31.587a4c4e.js"><link rel="prefetch" href="/assets/js/32.07d3f2a3.js"><link rel="prefetch" href="/assets/js/33.330ca2ab.js"><link rel="prefetch" href="/assets/js/34.644b8fec.js"><link rel="prefetch" href="/assets/js/35.2a59dd03.js"><link rel="prefetch" href="/assets/js/36.f24a64fb.js"><link rel="prefetch" href="/assets/js/37.4c48b883.js"><link rel="prefetch" href="/assets/js/38.e2ef6b4b.js"><link rel="prefetch" href="/assets/js/39.560ec89f.js"><link rel="prefetch" href="/assets/js/4.a64d0739.js"><link rel="prefetch" href="/assets/js/40.e9e6f1a1.js"><link rel="prefetch" href="/assets/js/41.c2b76d48.js"><link rel="prefetch" href="/assets/js/42.a837ca06.js"><link rel="prefetch" href="/assets/js/43.e6231a11.js"><link rel="prefetch" href="/assets/js/44.a06340cd.js"><link rel="prefetch" href="/assets/js/45.2e753f17.js"><link rel="prefetch" href="/assets/js/46.67d5bfd7.js"><link rel="prefetch" href="/assets/js/47.79d98f76.js"><link rel="prefetch" href="/assets/js/48.a27665a5.js"><link rel="prefetch" href="/assets/js/49.61035e35.js"><link rel="prefetch" href="/assets/js/5.05ac1e95.js"><link rel="prefetch" href="/assets/js/50.23d10ba5.js"><link rel="prefetch" href="/assets/js/51.ffd94a50.js"><link rel="prefetch" href="/assets/js/52.72645a49.js"><link rel="prefetch" href="/assets/js/54.29a19228.js"><link rel="prefetch" href="/assets/js/55.9dd56225.js"><link rel="prefetch" href="/assets/js/56.97ccbdc2.js"><link rel="prefetch" href="/assets/js/57.b5653684.js"><link rel="prefetch" href="/assets/js/58.5022402f.js"><link rel="prefetch" href="/assets/js/59.2788a4dc.js"><link rel="prefetch" href="/assets/js/6.2caff082.js"><link rel="prefetch" href="/assets/js/60.3a36e8b6.js"><link rel="prefetch" href="/assets/js/61.a58c0429.js"><link rel="prefetch" href="/assets/js/62.22142950.js"><link rel="prefetch" href="/assets/js/63.eb63df3a.js"><link rel="prefetch" href="/assets/js/64.5410a8b2.js"><link rel="prefetch" href="/assets/js/65.05534a28.js"><link rel="prefetch" href="/assets/js/66.345d568d.js"><link rel="prefetch" href="/assets/js/67.6d6c908d.js"><link rel="prefetch" href="/assets/js/68.48f8f647.js"><link rel="prefetch" href="/assets/js/69.0880f127.js"><link rel="prefetch" href="/assets/js/7.92af244d.js"><link rel="prefetch" href="/assets/js/70.6190682a.js"><link rel="prefetch" href="/assets/js/71.aef1621f.js"><link rel="prefetch" href="/assets/js/72.701beefb.js"><link rel="prefetch" href="/assets/js/73.5049b0f0.js"><link rel="prefetch" href="/assets/js/74.951b2541.js"><link rel="prefetch" href="/assets/js/75.a448589d.js"><link rel="prefetch" href="/assets/js/76.5245fdac.js"><link rel="prefetch" href="/assets/js/77.f76382e3.js"><link rel="prefetch" href="/assets/js/78.df1f1d7c.js"><link rel="prefetch" href="/assets/js/8.eef37b1f.js"><link rel="prefetch" href="/assets/js/9.e99284fe.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">会飞的鱼🐟</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basics/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/basics/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/basics/html/" class="nav-link">
  HTML
</a></li></ul></div></div><div class="nav-item"><a href="/frame/" class="nav-link">
  前端框架
</a></div><div class="nav-item"><a href="/engineering/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/project-practice/" class="nav-link">
  项目实践
</a></div><div class="nav-item"><a href="/browser/" class="nav-link router-link-active">
  浏览器
</a></div><div class="nav-item"><a href="/computer/" class="nav-link">
  计算机基础
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basics/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/basics/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/basics/html/" class="nav-link">
  HTML
</a></li></ul></div></div><div class="nav-item"><a href="/frame/" class="nav-link">
  前端框架
</a></div><div class="nav-item"><a href="/engineering/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/project-practice/" class="nav-link">
  项目实践
</a></div><div class="nav-item"><a href="/browser/" class="nav-link router-link-active">
  浏览器
</a></div><div class="nav-item"><a href="/computer/" class="nav-link">
  计算机基础
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>浏览器基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/browser/basics/url/" class="sidebar-link">从输入URL到页面呈现发生了什么</a></li><li><a href="/browser/basics/repaint/" class="sidebar-link">重绘和回流</a></li><li><a href="/browser/basics/safe/" class="sidebar-link">安全策略</a></li><li><a href="/browser/basics/cache/" aria-current="page" class="active sidebar-link">缓存策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/browser/basics/cache/#强缓存" class="sidebar-link">强缓存</a></li><li class="sidebar-sub-header"><a href="/browser/basics/cache/#协商缓存" class="sidebar-link">协商缓存</a></li><li class="sidebar-sub-header"><a href="/browser/basics/cache/#缓存位置" class="sidebar-link">缓存位置</a></li><li class="sidebar-sub-header"><a href="/browser/basics/cache/#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/browser/basics/local-store/" class="sidebar-link">本地存储</a></li><li><a href="/browser/basics/homology/" class="sidebar-link">同源策略</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>谷歌浏览器</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/browser/chrome/framework/" class="sidebar-link">Chrome架构</a></li><li><a href="/browser/chrome/performance/" class="sidebar-link">Performance</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="缓存策略"><a href="#缓存策略" class="header-anchor">#</a> 缓存策略</h1> <p>缓存是性能优化中非常重要的一环，浏览器的缓存对开发也是非常重要的知识点。</p> <h2 id="强缓存"><a href="#强缓存" class="header-anchor">#</a> 强缓存</h2> <p>浏览器的缓存作用分为两种情况，一种是需要发送<code>HTTP</code>请求，一种是不需要发送。</p> <p>首先是检测强缓存，这个阶段不需要发送<code>HTTP</code>请求。</p> <p>在<code>HTTP/1</code>和<code>HTTP/1.1</code>当中，这个字段是不一样的。在早起，也就是<code>HTTP/1</code>时期，使用的是<code>Expires</code>，而<code>HTTP/1.1</code>时期，使用的是<code>Cache-Control</code></p> <p><strong>Expires</strong></p> <p><code>Expires</code>即过期时间，存在于服务端返回的响应头中，告诉浏览器在这个过期时间之前可以直接从缓存里面获取数据，无需再次请求。</p> <p>格式如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
Expires: Wed, <span class="token number">22</span> Nov <span class="token number">2019</span> 08:41:00 GMT

</code></pre></div><p>表示资源在<em>2019年10月22号8点41分0秒</em>过期，过期了就得向服务器发送请求。</p> <p>这种方式可能存在的问题：服务器的时间和浏览器的时间可能不一致，那服务器返回的这个过期时间的计算可能就不准确。因此这种方式后来就被抛弃了。</p> <p><strong>Cache-Control</strong></p> <p>在<code>HTTP/1.1</code>中，采用了<code>Cache-Control</code>。它和<code>Expires</code>本质的区别在于：它没有采用<em>具体过期时间</em>这个方式，而是采用了<em>过期时长</em>来控制缓存，对应的字段是<code>max-age</code>。</p> <p>格式如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>
Cache-Control: max-age <span class="token operator">=</span> <span class="token number">3600</span>

</code></pre></div><p>代表这个响应放回后在3600秒（1小时内）可以直接使用缓存。</p> <p>除了<code>max-age</code>，它还有很多参数，用来完成更多缓存场景的判断。如下：</p> <ul><li><code>public</code>：客户端和代理服务器都可以缓存。因为一个请求可能要经过多个<em>代理服务器</em>最后才能到达目标服务器，那么结果就是不仅浏览器可以缓存数据，中间的任何代理节点都可以进行缓存。</li> <li><code>private</code>：只有浏览器可以缓存，中间的代理服务器不可以缓存。</li> <li><code>no-cache</code>：跳过当前的强缓存，发送HTTP请求，即直接进入<em>协商缓存</em>阶段。</li> <li><code>no-store</code>：不进行任何形式的缓存。</li> <li><code>s-maxage</code>：和<code>max-age</code>有点像，不同在于它是针对代理服务器的缓存时间。</li></ul> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>当 <code>Expires</code>和<code>Cache-Control</code>同时存在的时候，<code>Cache-Control</code>会被优先考虑</p></div> <p>还有一种情况，当资源缓存超时，也就是强缓存失效了，那么接下来就进入了第二道屏障——协商缓存了。</p> <h2 id="协商缓存"><a href="#协商缓存" class="header-anchor">#</a> 协商缓存</h2> <p>强缓存失效后，浏览器在请求头中携带缓存tag向服务器发送发送HTTP请求，由服务器根据这个tag来决定是否使用缓存，这就是<strong>协商缓存</strong>。</p> <p>具体来说，这样的缓存tag分为两种：<code>Last-Modified</code>和<code>ETag</code>。这两者各有优劣，并不存在谁对谁有绝对的优势。</p> <p><strong>Last-Modified</strong></p> <p>即最后修改时间。在浏览器第一次给服务器发送请求后，服务器会在响应头中加上这个字段。</p> <p>浏览器收到后，如果再次请求，会在请求中的携带<code>If-Modified-Since</code>字段，这个字段的值也就是服务器传来的最后修改时间。</p> <p>服务器拿到请求头中的<code>If-Modified-Since</code>字段后，会和服务器中该资源<em>最后修改时间</em>作对比：</p> <ul><li>如果请求头中的值小于最后修改时间，说明是时候更新了。则返回新的资源，更常规HTTP请求响应的流程一样。</li> <li>否则返回304，告诉浏览器直接用缓存。</li></ul> <p><strong>ETag</strong></p> <p><code>ETag</code>是服务器根据当前文件的内容，给文件生成的唯一标识，只要里面的内容有改动，这个值就会变。服务器通过响应头将这个值传递给浏览器。</p> <p>浏览器接收到<code>ETag</code>的值，会在下次请求的时候，将这个值作为<code>If-None-Match</code>这个字段的内容，并放在请求头中，然后发送给服务器。</p> <p>服务器接收到<code>If-None-Match</code>这个字段后，会跟服务器上该资源的<code>ETag</code>做对比：</p> <ul><li>如果两者不一样，说明要更新了。返回新的资源，更常规HTTP请求响应的流程一样。</li> <li>否则返回304，告诉浏览器直接用缓存。</li></ul> <p><strong>两者对比</strong></p> <ul><li>在精准度上，<code>ETag</code>优于<code>Last-Modified</code>。由于<code>ETag</code>是按照内容给资源加标识，因此能准确感知资源的变化。而<code>Last-Modified</code>不一样，它在一些特殊情况并不能准确感应资源的变化，主要有以下两种情况：
<ul><li>编辑了资源文件，但文件内容并没有修改，这样也会造成缓存失效。</li> <li><code>Last-Modified</code>能够感知的时间单位是秒，如果文件在1秒内改变多次，这个时候<code>Last-Modified</code>并没有体现出修改了。</li></ul></li> <li>在性能上，<code>Last-Modified</code>优于<code>ETag</code>。由于<code>Last-Modified</code>仅仅是记录一个时间点，而<code>ETag</code>要根据文件的内容生成哈希值。</li></ul> <div class="custom-block warning"><p class="custom-block-title">注意：</p> <p>如果两种方式都支持的话，服务器会优先考虑<code>ETag</code></p></div> <h2 id="缓存位置"><a href="#缓存位置" class="header-anchor">#</a> 缓存位置</h2> <p>当强缓存命中或者协商缓存中服务器返回304的时候，我们直接从缓存中获取资源。那么这些资源究竟缓存在什么位置呢？</p> <p>浏览器中的缓存位置一共有四中，按照优先级从高到低排列依次是：</p> <ul><li>Service Worker</li> <li>Memory Cache</li> <li>Disk Cache</li> <li>Push Cache</li></ul> <p><strong>Service Worker</strong></p> <p><code>Service Worker</code>借鉴了<code>Web Worker</code>的思路，即让JS运行在主线程之外，由于它脱离了浏览器的窗体，因此无法直接访问DOM。虽然如此，但它仍然能帮助我们完成很多有用的功能，比如<em>离线缓存</em>、<em>消息推送</em>和<em>网络代理</em>等功能。其中的离线缓存就是<code>Service Worker Cache</code>。</p> <p><code>Service Worker</code>同时也是PWA的重要实现机制.</p> <p><strong>Memory Cache</strong></p> <p><code>Memory Cache</code>指的是内存缓存，从效率上讲它是最快的。但是从存活时间来讲又是最短的，当渲染进程结束后，内存缓存也就不存在了。</p> <p><strong>Disk Cache</strong></p> <p><code>Disk Cache</code>就是存储在磁盘中的缓存，从存取效率上讲是比内存缓存慢的，但是他的优势在于存储容量和存储时长。</p> <div class="custom-block tip"><p class="custom-block-title">浏览器如何决定资源放在内存还是磁盘里呢？</p> <ul><li>比较大的<code>js/css</code>文件会被直接丢进磁盘，反之丢进内存</li> <li>内存使用率比较高的时候，文件优先进入磁盘</li></ul></div> <p><strong>Push Cache</strong></p> <p>即推送缓存，这是浏览器缓存的最后一道防线。它是<code>HTTP/2</code>中的内容，虽然现在应用的并不广泛，但随着<code>HTTP/2</code>的推广，它的应用越来越广泛。关于<code>Push Cache</code>，有非常多的内容可以挖掘。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>首先通过<code>Cache-Control</code>验证强缓存是否可以用</p> <ul><li>如果强缓存可用，直接使用</li> <li>否则进入协商缓存，即发送HTTP请求，服务器通过请求头中的<code>If-Modified-Since</code>或者<code>If-None-Match</code>字段检验资源是否更新：
<ul><li>若资源更新，则返回资源和200状态码</li> <li>若资源没有更新，返回304，告诉浏览器直接从缓存获取资源</li></ul></li></ul> <blockquote><p>参考文档：<a href="https://juejin.cn/post/6844904021308735502" target="_blank" rel="noopener noreferrer">浏览器灵魂之问<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/browser/basics/safe/" class="prev">
        安全策略
      </a></span> <span class="next"><a href="/browser/basics/local-store/">
        本地存储
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5fc96bdf.js" defer></script><script src="/assets/js/2.56cd01f5.js" defer></script><script src="/assets/js/53.fddcc9c3.js" defer></script>
  </body>
</html>

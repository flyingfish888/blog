<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>静态化方案 | 会飞的鱼🐟</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="学习笔记">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.5fc96bdf.js" as="script"><link rel="preload" href="/assets/js/2.56cd01f5.js" as="script"><link rel="preload" href="/assets/js/17.b89f8d5a.js" as="script"><link rel="prefetch" href="/assets/js/10.3ea21215.js"><link rel="prefetch" href="/assets/js/11.f2af6ae8.js"><link rel="prefetch" href="/assets/js/12.644b56f9.js"><link rel="prefetch" href="/assets/js/13.321b16b6.js"><link rel="prefetch" href="/assets/js/14.c75e2d6b.js"><link rel="prefetch" href="/assets/js/15.5b62c749.js"><link rel="prefetch" href="/assets/js/16.1365c67d.js"><link rel="prefetch" href="/assets/js/18.c2b2881c.js"><link rel="prefetch" href="/assets/js/19.793ae888.js"><link rel="prefetch" href="/assets/js/20.ceb40dc7.js"><link rel="prefetch" href="/assets/js/21.3872ab50.js"><link rel="prefetch" href="/assets/js/22.cdd80890.js"><link rel="prefetch" href="/assets/js/23.b89f5df5.js"><link rel="prefetch" href="/assets/js/24.00cc879e.js"><link rel="prefetch" href="/assets/js/25.e7d9e711.js"><link rel="prefetch" href="/assets/js/26.38dfa295.js"><link rel="prefetch" href="/assets/js/27.42e5a51b.js"><link rel="prefetch" href="/assets/js/28.f29c5a5a.js"><link rel="prefetch" href="/assets/js/29.9c1152d0.js"><link rel="prefetch" href="/assets/js/3.5ad5b76e.js"><link rel="prefetch" href="/assets/js/30.fb98a7fd.js"><link rel="prefetch" href="/assets/js/31.587a4c4e.js"><link rel="prefetch" href="/assets/js/32.07d3f2a3.js"><link rel="prefetch" href="/assets/js/33.330ca2ab.js"><link rel="prefetch" href="/assets/js/34.644b8fec.js"><link rel="prefetch" href="/assets/js/35.2a59dd03.js"><link rel="prefetch" href="/assets/js/36.f24a64fb.js"><link rel="prefetch" href="/assets/js/37.4c48b883.js"><link rel="prefetch" href="/assets/js/38.e2ef6b4b.js"><link rel="prefetch" href="/assets/js/39.560ec89f.js"><link rel="prefetch" href="/assets/js/4.a64d0739.js"><link rel="prefetch" href="/assets/js/40.e9e6f1a1.js"><link rel="prefetch" href="/assets/js/41.c2b76d48.js"><link rel="prefetch" href="/assets/js/42.a837ca06.js"><link rel="prefetch" href="/assets/js/43.e6231a11.js"><link rel="prefetch" href="/assets/js/44.a06340cd.js"><link rel="prefetch" href="/assets/js/45.2e753f17.js"><link rel="prefetch" href="/assets/js/46.67d5bfd7.js"><link rel="prefetch" href="/assets/js/47.79d98f76.js"><link rel="prefetch" href="/assets/js/48.a27665a5.js"><link rel="prefetch" href="/assets/js/49.61035e35.js"><link rel="prefetch" href="/assets/js/5.05ac1e95.js"><link rel="prefetch" href="/assets/js/50.23d10ba5.js"><link rel="prefetch" href="/assets/js/51.ffd94a50.js"><link rel="prefetch" href="/assets/js/52.72645a49.js"><link rel="prefetch" href="/assets/js/53.fddcc9c3.js"><link rel="prefetch" href="/assets/js/54.29a19228.js"><link rel="prefetch" href="/assets/js/55.9dd56225.js"><link rel="prefetch" href="/assets/js/56.97ccbdc2.js"><link rel="prefetch" href="/assets/js/57.b5653684.js"><link rel="prefetch" href="/assets/js/58.5022402f.js"><link rel="prefetch" href="/assets/js/59.2788a4dc.js"><link rel="prefetch" href="/assets/js/6.2caff082.js"><link rel="prefetch" href="/assets/js/60.3a36e8b6.js"><link rel="prefetch" href="/assets/js/61.a58c0429.js"><link rel="prefetch" href="/assets/js/62.22142950.js"><link rel="prefetch" href="/assets/js/63.eb63df3a.js"><link rel="prefetch" href="/assets/js/64.5410a8b2.js"><link rel="prefetch" href="/assets/js/65.05534a28.js"><link rel="prefetch" href="/assets/js/66.345d568d.js"><link rel="prefetch" href="/assets/js/67.6d6c908d.js"><link rel="prefetch" href="/assets/js/68.48f8f647.js"><link rel="prefetch" href="/assets/js/69.0880f127.js"><link rel="prefetch" href="/assets/js/7.92af244d.js"><link rel="prefetch" href="/assets/js/70.6190682a.js"><link rel="prefetch" href="/assets/js/71.aef1621f.js"><link rel="prefetch" href="/assets/js/72.701beefb.js"><link rel="prefetch" href="/assets/js/73.5049b0f0.js"><link rel="prefetch" href="/assets/js/74.951b2541.js"><link rel="prefetch" href="/assets/js/75.a448589d.js"><link rel="prefetch" href="/assets/js/76.5245fdac.js"><link rel="prefetch" href="/assets/js/77.f76382e3.js"><link rel="prefetch" href="/assets/js/78.df1f1d7c.js"><link rel="prefetch" href="/assets/js/8.eef37b1f.js"><link rel="prefetch" href="/assets/js/9.e99284fe.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">会飞的鱼🐟</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basics/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/basics/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/basics/html/" class="nav-link">
  HTML
</a></li></ul></div></div><div class="nav-item"><a href="/frame/" class="nav-link">
  前端框架
</a></div><div class="nav-item"><a href="/engineering/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/project-practice/" class="nav-link router-link-active">
  项目实践
</a></div><div class="nav-item"><a href="/browser/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/computer/" class="nav-link">
  计算机基础
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basics/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/basics/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/basics/html/" class="nav-link">
  HTML
</a></li></ul></div></div><div class="nav-item"><a href="/frame/" class="nav-link">
  前端框架
</a></div><div class="nav-item"><a href="/engineering/" class="nav-link">
  前端工程化
</a></div><div class="nav-item"><a href="/project-practice/" class="nav-link router-link-active">
  项目实践
</a></div><div class="nav-item"><a href="/browser/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/computer/" class="nav-link">
  计算机基础
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/project-practice/h5-static/" class="sidebar-heading clickable router-link-active open"><span>H5静态化</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/project-practice/h5-static/programme/" aria-current="page" class="active sidebar-link">静态化方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/project-practice/h5-static/programme/#_1-隐藏webview启动模块" class="sidebar-link">1. 隐藏Webview启动模块</a></li><li class="sidebar-sub-header"><a href="/project-practice/h5-static/programme/#_2-预加载器模块" class="sidebar-link">2. 预加载器模块</a></li><li class="sidebar-sub-header"><a href="/project-practice/h5-static/programme/#_3-静态资源url列表配置模块" class="sidebar-link">3. 静态资源URL列表配置模块</a></li><li class="sidebar-sub-header"><a href="/project-practice/h5-static/programme/#_4-针对html主文档的预加载" class="sidebar-link">4. 针对HTML主文档的预加载</a></li><li class="sidebar-sub-header"><a href="/project-practice/h5-static/programme/#_5-成本分析" class="sidebar-link">5. 成本分析</a></li><li class="sidebar-sub-header"><a href="/project-practice/h5-static/programme/#_6-预加载策略" class="sidebar-link">6. 预加载策略</a></li><li class="sidebar-sub-header"><a href="/project-practice/h5-static/programme/#_7-缓存命中率统计-复盘" class="sidebar-link">7. 缓存命中率统计/复盘</a></li><li class="sidebar-sub-header"><a href="/project-practice/h5-static/programme/#_8-app启动时webview内置公共基础库" class="sidebar-link">8. App启动时WebView内置公共基础库</a></li><li class="sidebar-sub-header"><a href="/project-practice/h5-static/programme/#_9-与离线化-离线包方案的对比" class="sidebar-link">9. 与离线化/离线包方案的对比</a></li><li class="sidebar-sub-header"><a href="/project-practice/h5-static/programme/#_10-总结与期望收益" class="sidebar-link">10. 总结与期望收益</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/project-practice/d3js/" class="sidebar-heading clickable"><span>D3js</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/project-practice/d3js/introduction/" class="sidebar-link">D3js入门</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/project-practice/micro-frontends/" class="sidebar-heading clickable"><span>微前端</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/project-practice/micro-frontends/knowledge/" class="sidebar-link">基础知识</a></li><li><a href="/project-practice/micro-frontends/qiankun/" class="sidebar-link">乾坤框架</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="静态化方案"><a href="#静态化方案" class="header-anchor">#</a> 静态化方案</h1> <p>App内网页静态资源预加载，提高h5转化率</p> <p><strong>具体方案</strong></p> <p><img src="/assets/img/progress.fb0319c0.png" alt="progress"></p> <h2 id="_1-隐藏webview启动模块"><a href="#_1-隐藏webview启动模块" class="header-anchor">#</a> 1. 隐藏Webview启动模块</h2> <p>此模块由客户端实现，主要功能：</p> <ul><li>在App启动或进入导航类Native页面时，初始化一个隐藏不可见的WebView组件，打开预加载器模块H5页面</li> <li>一般仅在 <em>网络空闲</em>、<em>使用WIFI</em> 情况下执行，以避免占用用户正常访问带宽，节省用户流量成本</li></ul> <h2 id="_2-预加载器模块"><a href="#_2-预加载器模块" class="header-anchor">#</a> 2. 预加载器模块</h2> <p>此模块由Web前端实现，类似pwa的<code>service worker</code>主要功能：</p> <ul><li>请求服务端接口，获取需要预加载的静态资源URL列表</li> <li>调用浏览器Fetch方法，下载列表中的静态资源，存储到WebView HTTP缓存区</li> <li>静态资源下载完毕后，通知Native销毁隐藏WebView</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 预加载器核心代码示例</span>
<span class="token keyword">function</span> <span class="token function">prefetch</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> self<span class="token punctuation">.</span>fetch <span class="token operator">==</span> <span class="token keyword">null</span>
 <span class="token operator">?</span> <span class="token function">xhrPrefetchStrategy</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> credentials<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">omit</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
​
<span class="token keyword">function</span> <span class="token function">xhrPrefetchStrategy</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function-variable function">resolve</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function-variable function">reject</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token keyword">const</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 req<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">GET</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 req<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 req<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span> <span class="token operator">?</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
 req<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>客户端打开APP空闲时下载白名单列表，下载成功后缓存，白名单可在CMS配置；前期考虑快速迭代，白名单可先不配置，直接客户端固定白名单；白名单列表：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> h5_white_list <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">&quot;https://a.com&quot;</span><span class="token punctuation">,</span> 
  <span class="token string">&quot;https://b.mobi&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;https://c.app&quot;</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_3-静态资源url列表配置模块"><a href="#_3-静态资源url列表配置模块" class="header-anchor">#</a> 3. 静态资源URL列表配置模块</h2> <p>此模块由服务端实现，通常以管理配置平台的形式，开放给所有业务线接入，主要功能：</p> <ul><li>配置和管理需要被预加载的各网页应用的URL列表</li> <li>组合所有接入方的URL列表，形成统一列表，提供给预加载器模块调用</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// URL列表配置接口示意</span>

<span class="token comment">// 资源列表接口URL：https://www.company.com/prefetch-platform/config.json</span>
<span class="token comment">// 资源列表接口响应体示例</span>
<span class="token comment">// 实际返回给预加载器页面的结果，需要对此配置中的assetsURL进行请求后，返回实际要加载的URL地址</span>
<span class="token punctuation">{</span>
 <span class="token string">&quot;prefetch&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 全局预加载开关</span>
 <span class="token string">&quot;end&quot;</span><span class="token operator">:</span><span class="token string">&quot;appName&quot;</span>    <span class="token comment">//对应哪个端</span>
 <span class="token string">&quot;assets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>       <span class="token comment">// 资源URL列表</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;projectA&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 接入项目名称</span>
       <span class="token string">&quot;assetsURL&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://www.company.com/projectA/prefetch-assets.json&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 接入项目资源列表接口地址</span>
       <span class="token string">&quot;prefetch&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// demo项目预加载开关</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;projectA&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;assetsURL&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://www.company.com/projectB/prefetch-assets.json&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;prefetch&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接入方要接入App预加载功能，需要：</p> <ul><li>项目上线时，构建生成自己项目的静态资源URL列表</li> <li>设置静态资源响应头，允许预加载器跨域下载列表中的资源</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 接入方式示例</span>

<span class="token comment">// 1、构建URL列表</span>
<span class="token comment">// 资源列表接口URL：https://www.company.com/projectA/prefetch-assets.json</span>
<span class="token comment">// 资源列表接口响应体：</span>
<span class="token punctuation">{</span>
 <span class="token string">&quot;prefetch&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否开启预加载</span>
 <span class="token string">&quot;end&quot;</span><span class="token operator">:</span><span class="token string">&quot;appA&quot;</span>  
 <span class="token string">&quot;assets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token comment">// 资源URL列表</span>
    <span class="token string">&quot;https://www.company.com/projectA/js/index.abcd1234.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;https://www.company.com/projectA/css/index.abcd1234.css&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;https://www.company.com/projectA/img/index.abcd1234.png&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 2、资源跨域头设置</span>
location <span class="token operator">~</span><span class="token operator">*</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span>html<span class="token operator">|</span>js<span class="token operator">|</span>css<span class="token operator">|</span>png<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
 add_header Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Origin <span class="token operator">*</span><span class="token punctuation">;</span>            
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_4-针对html主文档的预加载"><a href="#_4-针对html主文档的预加载" class="header-anchor">#</a> 4. 针对HTML主文档的预加载</h2> <p>上面我们已经对网页中的JavaScript/CSS等资源进行了预加载，我们还需要对html进行预先加载</p> <p>入口HTML通常设置为不缓存，每次请求都会从服务端获取最新内容。这就导致HTML无法进行预加载，进而导致整个网页应用无法实现离线化（断网可用）。</p> <p>要解决这一问题，我们需要给HTML文档增加版本号，并应用新的缓存策略。主要实现思路如下</p> <p>（1）在项目上线构建时，对 <em>HTML主文档/Node入口链接</em> 增加版本号，并将带版本号的入口地址URL，传给服务端入口配置系统更新</p> <p>例如： 服务器增加一个额外的接口</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
   currentVersion<span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">,</span>
   project<span class="token operator">:</span><span class="token string">'projectA'</span><span class="token punctuation">,</span>
   link<span class="token operator">:</span><span class="token string">'https://gamewhateverstuff.app'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>（2）通过服务端接口，下发带版本号的入口URL</p> <p>（3）客户端对比版本号，确定是否预加载所有静态资源（包括HTML）项目URL配置列表示例</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 配置URL示例</span>
<span class="token punctuation">{</span>
 <span class="token string">&quot;prefetch&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
 <span class="token string">&quot;assets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
   <span class="token string">&quot;https://www.company.com/projectA/index.20190501124536.html&quot;</span><span class="token punctuation">,</span>
   <span class="token string">&quot;https://www.company.com/projectA/index.20190501124536.html?from=test&quot;</span><span class="token punctuation">,</span>
   <span class="token string">&quot;https://www.company.com/projectA/js/index.abcd1234.js&quot;</span><span class="token punctuation">,</span>
   <span class="token string">&quot;https://www.company.com/projectA/css/index.abcd1234.css&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对这些资源进行预加载后，便可以实现在用户首次访问页面时，所有的静态资源都从本地缓存读取。主要收益：</p> <ul><li><p>消除静态资源下载带来的网络连接建立、数据传输等时间消耗，提高网页应用启动速度和点击转化率</p></li> <li><p>实现网站首页完全离线化，很大程度上解除应用对静态资源服务器的核心依赖，提高系统可用性</p></li></ul> <p>（4）服务端API接口数据也可以离线。</p> <p>对于页面使用前端渲染的项目，除HTML/JS/CSS等静态数据外，应用首次启动一般还会有服务端API数据请求，此请求的离线化思路是：</p> <ul><li><p>先尝试网络请求，失败后走下一步</p></li> <li><p>从本地LocalStorage读取（数据为上一次正常网络请求时存储），如果读取成功，则用上次的API数据渲染，并在页面上展示网络异常通知文案；如果读取失败，则走下一步；</p></li> <li><p>展示JavaScript代码中内置的默认兜底数据，以及网络异常通知文案</p></li></ul> <h2 id="_5-成本分析"><a href="#_5-成本分析" class="header-anchor">#</a> 5. 成本分析</h2> <p>由于用户浏览行为的难以预测性，静态资源预加载会带来一定的流量浪费，需要对这部分成本进行核算。</p> <p>（1）企业下行带宽成本</p> <p>以预加载一个H5项目（资源大小100KB）1000万次为例，增加流量 = 1000万 * 100KB ≈ 1TB。</p> <p>（2）用户手机流量成本</p> <p>以预加载50个网页项目为例，增加的手机流量 = 50 * 100KB ≈ 5MB，仅在WIFI下载则用户成本更低。
这里需要指出的是，并非每次App启动都会下载5MB。在一个项目上线周期内，缓存资源失效前，仅会下载1次，后续资源预加载请求也会命中缓存。
预加载并非适合所有的项目场景，不同项目的投入产出比是不同的，需要具体项目具体分析，以上给出的是成本分析的计算方法。</p> <p>下面给出一些适用的项目场景：</p> <ul><li><p>高点击率、大流量网页项目。高点击率、大流量意味着高缓存命中、低流量浪费，如：点击App首页banner打开的热点活动网页</p></li> <li><p>对启动速度和转化率有极致要求的网页项目。如：游戏项目、其他一些抽奖项目。</p></li> <li><p>不适合的项目。流量小、转化收益低的项目</p></li></ul> <h2 id="_6-预加载策略"><a href="#_6-预加载策略" class="header-anchor">#</a> 6. 预加载策略</h2> <p>如果上述成本还无法接受，我们可以通过静态化和动态化策略，进一步降成本。</p> <p>（1）静态化预加载策略</p> <ul><li><p>仅下载大流量/重点项目</p></li> <li><p>仅WIFI环境和浏览器网络空闲时下载</p></li> <li><p>在网页启动前，最近的 <em>上一步或上两步Native页面</em> 预加载，而不是都放到App启动时下载</p></li> <li><p>仅预加载网站 <em>首页</em> 需要的静态资源，首页之外后续其他页面的静态资源，由网站首页进行预加载</p></li> <li><p>按照项目配置的优先级顺序分批下载，控制每次并发的下载连接数，响应缓慢时及时终止下载</p></li></ul> <p>上述部分策略，需通过服务端管理平台落地，实现在合适的时机下载合适的项目。</p> <p>（2）动态化智能预加载策略</p> <ul><li><p><strong>基于用户画像</strong>（包括基础画像、长期画像、用户行为轨迹、实时数据、历史数据等），预测一个用户未来会点击哪些页面，计算出未来访问概率</p></li> <li><p>基于投放的面向用户，只投放给有门槛的用户</p></li> <li><p>仅仅下载访问概率高于特定阈值项目的静态资源</p></li></ul> <p>动态策略举例：仅针对未登录用户，预加载登陆网页的静态资源。这里需要指出的是，部分动态化策略的实现，需要大量研发资源和计算资源的投入，这部分投入可能已经远远超过了流量成本，因此在实施动态化策略时，需要综合评估考虑。</p> <h2 id="_7-缓存命中率统计-复盘"><a href="#_7-缓存命中率统计-复盘" class="header-anchor">#</a> 7. 缓存命中率统计/复盘</h2> <p>通过前端的性能监控系统<code>Nemo Metric</code>来得知请求的静态资源是fromLocalCache还是fromRemoteServer。</p> <p>具体思路：performance.getEntries() ，可以获取每一个静态资源的请求信息，其返回如下图：</p> <p><img src="/assets/img/fetchTime.9ca412d0.png" alt="fetchTime"></p> <ul><li><p>fetchTime等于0：说明从缓存读取，即fromLocalCache</p></li> <li><p>fetchTime不等于0 说明从网络读取，即fromRemoteServer</p></li> <li><p>缓存命中率 = fromLocalCache/(fromRemoteServer + fromLocalCache)</p></li></ul> <p>这里需要指出的是，缓存命中率只是一个过程指标，在项目初期，建议将更多精力关注到 <em>完全加载时间</em> 和 <em>页面加载成功率</em> 等结果指标上。</p> <h2 id="_8-app启动时webview内置公共基础库"><a href="#_8-app启动时webview内置公共基础库" class="header-anchor">#</a> 8. App启动时WebView内置公共基础库</h2> <p>在组件化、服务化盛行的今天，各个前端项目之间，共用了大量的基础库、组件库、业务框架，对于这些共用的部分，可以独立成一组公共静态资源，在App启动时预加载，直接内置到WebView缓存中。 比如下面这些资源：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 13kb</span>
https://unpkg.com/react@16/umd/react.production.min.js
<span class="token comment"># 103kb</span>
https://unpkg.com/react-dom@16/umd/react-dom.production.min.js
<span class="token comment"># 13.4kb</span>
https://unpkg.com/axios/dist/axios.min.js
</code></pre></div><p>业务项目只需要引用这些地址，便可以直接从WebView缓存中读取公共库。</p> <h2 id="_9-与离线化-离线包方案的对比"><a href="#_9-与离线化-离线包方案的对比" class="header-anchor">#</a> 9. 与离线化/离线包方案的对比</h2> <p>在解决静态资源下载慢这一问题上，业界还有一种广为应用的技术方案，既：离线化/离线包方案。其主要思路是：</p> <ul><li>将包括HTML/JS/CSS等静态资源打包到一个压缩包内，在用户访问项目前，预先下载该离线包到本地并解压</li> <li>当用户访问页面发出资源请求时，WebView容器会对请求进行拦截，如果已经在离线包内，会使用离线包中的本地资源响应给用户</li></ul> <p><img src="/assets/img/duibi.360c96a8.png" alt="duibi"></p> <p>如果在App启动时进行预加载且App DAU很高，容易导致静态资源服务器QPS激增，形成流量突刺造成宕机，需要做好流量预估，逐步放量。针对于我们目前这么大的量，该方案成本高，不合适</p> <h2 id="_10-总结与期望收益"><a href="#_10-总结与期望收益" class="header-anchor">#</a> 10. 总结与期望收益</h2> <p>App应用的功能代码，通常在用户访问之前，就已经以安装包的形式，通过应用市场下载安装好了。而网页应用的功能代码（静态资源），则是在用户实际点击访问时，才实时下载运行。</p> <p>这一『用时下载』的特点是一把双刃剑，既带来了实时更新的灵活性，也造成了应用启动的延迟，导致网页应用启动速度远远落后于App应用，造成交互体验和用户转化短板。</p> <p>本文提出的基于静态资源预加载技术，提升App内网页启动速度的新方案。根据目前加载过程的耗时与流失高，此方案估计可显著提升网页启动速度（缩短页面加载时间30%-50%以上）、提高网页加载成功率。</p> <blockquote><p>参考文档：<a href="https://juejin.cn/post/6844904048257138695" target="_blank" rel="noopener noreferrer">App内网页静态资源预加载 提高H5转化率<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/project-practice/d3js/introduction/">
        D3js入门
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5fc96bdf.js" defer></script><script src="/assets/js/2.56cd01f5.js" defer></script><script src="/assets/js/17.b89f8d5a.js" defer></script>
  </body>
</html>
